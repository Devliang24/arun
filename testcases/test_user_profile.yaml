config:
  name: Update Current User Profile
  base_url: ${ENV(BASE_URL)}
  variables:
    user_username: ${ENV(USER_USERNAME)}
    user_password: ${ENV(USER_PASSWORD)}
    new_full_name: User_${short_uid(12)}
    new_address: "No.9 Automation Rd"
  tags: [users]
steps:
  - name: register user
    request:
      method: POST
      url: /api/v1/auth/register
      json:
        username: u_${short_uid(12)}
        email: u_${uid()}@example.com
        password: "P@ssw0rd123"
        full_name: "User_${short_uid(10)}"
        shipping_address: ${ENV(SHIPPING_ADDRESS)}
    extract:
      user_username: $.data.username
    validate:
      - in: [status_code, [200, 201]]
      - eq: [$.success, true]
      - eq: [$.message, "用户注册成功"]

  - name: login
    request:
      method: POST
      url: /api/v1/auth/login
      json:
        username: $user_username
        password: $user_password
    extract:
      token: $.data.access_token
    validate:
      - eq: [status_code, 200]
      - eq: [$.success, true]
      - eq: [$.message, "登录成功"]
      - eq: [$.data.user.username, $user_username]

  - name: update me
    variables:
      authz: "Bearer $token"
    request:
      method: PUT
      url: /api/v1/users/me
      headers:
        Authorization: $authz
      json:
        full_name: $new_full_name
        shipping_address: $new_address
    validate:
      - eq: [status_code, 200]
      - eq: [$.success, true]
      - eq: [$.message, "用户信息更新成功"]
      - eq: [$.data.full_name, $new_full_name]
      - eq: [$.data.shipping_address, $new_address]

  - name: get me
    variables:
      authz: "Bearer $token"
    request:
      method: GET
      url: /api/v1/users/me
      headers:
        Authorization: $authz
    validate:
      - eq: [status_code, 200]
      - contains: [$.data.shipping_address, $new_address]
      - eq: [$.success, true]
      - eq: [$.message, "获取用户信息成功"]
      - eq: [$.data.username, $user_username]
      - eq: [$.data.full_name, $new_full_name]

config:
  name: Cart Operations
  base_url: ${ENV(BASE_URL)}
  tags: [cart]
  variables:
    user_username: ${ENV(USER_USERNAME)}
    user_password: ${ENV(USER_PASSWORD)}
steps:
  - name: login
    request:
      method: POST
      url: /api/v1/auth/login
      json:
        username: $user_username
        password: $user_password
    extract:
      token: $.data.access_token
    validate:
      - eq: [status_code, 200]
      - eq: [$.success, true]
      - eq: [$.message, "登录成功"]
      - eq: [$.data.user.username, $user_username]
      - regex: [$.data.access_token, "^[A-Za-z0-9_-]+\\.[A-Za-z0-9_-]+\\.[A-Za-z0-9_-]+$"]

  - name: get product
    request:
      method: GET
      url: /api/v1/products/
    extract:
      product_id: $.data.items[0].id
    validate:
      - eq: [status_code, 200]
      - eq: [$.success, true]
      - eq: [$.code, 200]
      - gt: [$.data.total, 0]
      - gt: ["$.data.items[0].price", 0.0]
      - contains: ["$.data.items[0]", "product_name"]

  - name: add to cart
    variables:
      authz: "Bearer $token"
    request:
      method: POST
      url: /api/v1/cart/items
      headers:
        Authorization: $authz
      json:
        product_id: $product_id
        quantity: 2
    validate:
      - eq: [status_code, 201]
      - eq: [$.success, true]
      - eq: [$.code, 201]
      - eq: [$.message, "添加商品到购物车成功"]
      - len_eq: [$.data.items, 1]
      - eq: ["$.data.items[0].product_id", $product_id]
      - eq: ["$.data.items[0].quantity", 2]
      - gt: [$.data.total_price, 0.0]

  - name: update quantity
    variables:
      authz: "Bearer $token"
    request:
      method: PUT
      url: /api/v1/cart/items/$product_id
      headers:
        Authorization: $authz
      json:
        quantity: 1
    validate:
      - eq: [status_code, 200]
      - eq: [$.success, true]
      - eq: [$.message, "更新购物车成功"]
      - len_eq: [$.data.items, 1]
      - eq: ["$.data.items[0].product_id", $product_id]
      - eq: ["$.data.items[0].quantity", 1]

  - name: get cart
    variables:
      authz: "Bearer $token"
    request:
      method: GET
      url: /api/v1/cart/
      headers:
        Authorization: $authz
    validate:
      - eq: [status_code, 200]
      - eq: [$.success, true]
      - eq: [$.code, 200]
      - eq: [$.message, "获取购物车成功"]
      - len_eq: [$.data.items, 1]
      - eq: ["$.data.items[0].quantity", 1]

  - name: remove from cart
    variables:
      authz: "Bearer $token"
    request:
      method: DELETE
      url: /api/v1/cart/items/$product_id
      headers:
        Authorization: $authz
    validate:
      - eq: [status_code, 200]
      - eq: [$.success, true]
      - eq: [$.message, "从购物车移除商品成功"]
      - len_eq: [$.data.items, 0]
      - eq: [$.data.total_items, 0]

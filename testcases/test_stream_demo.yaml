config:
  name: 流式响应测试示例
  base_url: ${ENV(BASE_URL, https://dgi.deepexi.com)}
  variables:
    api_key: ${ENV(API_KEY, sk-demo)}
  tags: [stream, demo]

steps:
  - name: 流式聊天对话
    request:
      method: POST
      url: /v1/chat/completions
      headers:
        Authorization: Bearer $api_key
        Content-Type: application/json
      body:
        model: "Qwq-32B"
        messages:
          - role: user
            content: "hello"
        stream: true
      stream: true
      stream_timeout: 30
    
    extract:
      # 提取第一个事件的内容
      first_content: $.stream_events[0].data.choices[0].delta.content
      # 提取最后一个事件的完成原因
      finish_reason: $.stream_events[-1].data.choices[0].finish_reason
      # 提取事件总数
      event_count: $.stream_summary.event_count
    
    validate:
      # 验证HTTP状态码
      - eq: [status_code, 200]
      # 验证至少有一个事件
      - gt: [$event_count, 0]
      # 验证首包时间
      - lt: [$.stream_summary.first_chunk_ms, 2000]
      # 验证总耗时
      - lt: [$elapsed_ms, 10000]

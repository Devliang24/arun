config:
  name: 用户注册后创建商品
  base_url: ${ENV(BASE_URL)}
  tags: [user, products]
  variables:
    username: u_${short_uid(12)}
    email: u_${uid()}@example.com
    full_name: DemoUser_${short_uid(10)}
    password: Pwd_${short_uid(12)}
    shipping_address: Addr_${short_uid(12)}
    product_name: Product_${short_uid(8)}
    product_description: Demo product created by user flow.
    product_price: 22
    product_stock: 30
    product_category_id: 1
steps:
  - name: 注册用户
    request:
      method: POST
      url: /api/v1/auth/register
      body:
        username: $username
        email: $email
        password: $password
        full_name: $full_name
        shipping_address: $shipping_address
    extract:
      username: $.data.username
    validate:
      - in: [status_code, [200, 201]]
      - eq: [$.success, true]
      - eq: [$.message, "用户注册成功"]

  - name: 登录
    request:
      method: POST
      url: /api/v1/auth/login
      body:
        username: $username
        password: $password
    extract:
      token: $.data.access_token
    validate:
      - eq: [status_code, 200]
      - eq: [$.success, true]
      - eq: [$.message, "登录成功"]
      - eq: [$.data.user.username, $username]

  - name: 创建商品
    request:
      method: POST
      url: /api/v1/products
      headers:
        Authorization: Bearer $token
      body:
        name: $product_name
        description: $product_description
        price: $product_price
        stock: $product_stock
        category_id: $product_category_id
      extract:
        product_id: $.data.id
      validate:
        - eq: [status_code, 201]
        - eq: [$.success, true]
        - eq: [$.message, "商品创建成功"]
        - eq: [$.data.name, $product_name]

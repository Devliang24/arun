config:
  name: Orders
  base_url: ${ENV(BASE_URL)}
  variables:
    user_username: ${ENV(USER_USERNAME)}
    user_password: ${ENV(USER_PASSWORD)}
    shipping_address: ${ENV(SHIPPING_ADDRESS)}
tags: [orders]
setup_hooks: [setup_hook_sign_request]
teardown_hooks: [teardown_hook_assert_status_ok]
steps:
  - name: login
    request:
      method: POST
      url: /api/v1/auth/login
      json:
        username: $user_username
        password: $user_password
    extract:
      token: $.data.access_token
    validate:
      - eq: [status_code, 200]

  - name: get product
    request:
      method: GET
      url: /api/v1/products/
    teardown_hooks: [teardown_hook_capture_request_id]
    extract:
      product_id: $.items[0].id
    validate:
      - eq: [status_code, 200]

  - name: add to cart
    variables:
      authz: Bearer $token
    request:
      method: POST
      url: /api/v1/cart/items
      headers:
        Authorization: $authz
        X-Request-Id: $request_id
      json:
        product_id: $product_id
        quantity: 1
    validate:
      - eq: [status_code, 201]

  - name: checkout
    variables:
      authz: Bearer $token
    request:
      method: POST
      url: /api/v1/orders/
      headers:
        Authorization: $authz
      json:
        shipping_address: $shipping_address
    extract:
      order_id: $.id
    validate:
      - eq: [status_code, 201]

  - name: get order detail
    variables:
      authz: Bearer $token
    request:
      method: GET
      url: /api/v1/orders/$order_id
      headers:
        Authorization: $authz
    validate:
      - eq: [status_code, 200]

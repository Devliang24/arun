config:
  name: 管理员创建商品
  base_url: ${ENV(BASE_URL)}
  tags: [admin, products]
  variables:
    admin_username: ${ENV(ADMIN_USERNAME, "admin")}
    admin_password: ${ENV(ADMIN_PASSWORD, "secret")}
    product_name: 商品_${short_uid(10)}
    product_description: 自动化创建商品_${short_uid(6)}
    product_price: 199.99
    product_stock: 20

steps:
  - name: 管理员登录
    request:
      method: POST
      url: /api/v1/auth/login
      headers:
        Accept: application/json
        Content-Type: application/json
      body:
        username: $admin_username
        password: $admin_password
    extract:
      admin_token: $.data.access_token
      admin_user_id: $.data.user.id
      admin_role: $.data.user.role
    validate:
      - eq: [status_code, 200]
      - eq: [$.success, true]
      - contains: [$.message, 成功]
      - eq: [$.data.user.role, admin]

  - name: 获取分类列表
    request:
      method: GET
      url: /api/v1/categories/
      headers:
        Accept: application/json
        Authorization: Bearer $admin_token
    extract:
      category_id: $.data[0].id
    validate:
      - eq: [status_code, 200]
      - eq: [$.success, true]
      - gt: ['$.data[0].id', 0]

  - name: 管理员创建商品
    request:
      method: POST
      url: /api/v1/products/
      headers:
        Accept: application/json
        Content-Type: application/json
        Authorization: Bearer $admin_token
      body:
        name: $product_name
        description: $product_description
        price: $product_price
        stock: $product_stock
        category_id: $category_id
    extract:
      new_product_id: $.data.id
      created_at: $.data.created_at
    validate:
      - in: [status_code, [200, 201]]
      - eq: [$.success, true]
      - eq: [$.data.name, $product_name]
      - eq: [$.data.category_id, $category_id]

  - name: 验证商品详情
    request:
      method: GET
      url: /api/v1/products/$new_product_id
      headers:
        Accept: application/json
        Authorization: Bearer $admin_token
    validate:
      - eq: [status_code, 200]
      - eq: [$.success, true]
      - eq: [$.data.id, $new_product_id]
      - eq: [$.data.name, $product_name]
      - eq: [$.data.category_id, $category_id]
      - ge: [$.data.stock, $product_stock]

config:
  name: 更新当前用户信息
  base_url: ${ENV(BASE_URL)}
  variables:
    username: u_${short_uid(12)}
    email: u_${uid()}@example.com
    full_name: User_${short_uid(10)}
    password: Pwd_${short_uid(12)}
    shipping_address: Addr_${short_uid(12)}
    new_full_name: User_${short_uid(12)}
    new_address: No.9 Automation Rd
  tags: [users]

steps:
  - name: 注册用户
    request:
      method: POST
      path: /api/v1/auth/register
      headers:
        Accept: application/json
        Content-Type: application/json
      body:
        username: $username
        email: $email
        password: $password
        full_name: $full_name
        shipping_address: $shipping_address
    extract:
      username: $.data.username
    validate:
      - in: [status_code, [200, 201]]
      - eq: [$.success, true]
      - eq: [$.message, 用户注册成功]

  - name: 登录
    request:
      method: POST
      path: /api/v1/auth/login
      headers:
        Accept: application/json
        Content-Type: application/json
      body:
        username: $username
        password: $password
    extract:
      token: $.data.access_token
    validate:
      - eq: [status_code, 200]
      - eq: [$.success, true]
      - eq: [$.message, 登录成功]
      - eq: [$.data.user.username, $username]

  - name: 更新个人信息
    request:
      method: PUT
      path: /api/v1/users/me
      headers:
        Accept: application/json
        Content-Type: application/json
        Authorization: Bearer $token
      body:
        full_name: $new_full_name
        shipping_address: $new_address
    validate:
      - eq: [status_code, 200]
      - eq: [$.success, true]
      - eq: [$.message, 用户信息更新成功]
      - eq: [$.data.full_name, $new_full_name]
      - eq: [$.data.shipping_address, $new_address]

  - name: 获取我的信息
    request:
      method: GET
      path: /api/v1/users/me
      headers:
        Accept: application/json
        Authorization: Bearer $token
    validate:
      - eq: [status_code, 200]
      - contains: [$.data.shipping_address, $new_address]
      - eq: [$.success, true]
      - eq: [$.message, 获取用户信息成功]
      - eq: [$.data.username, $username]
      - eq: [$.data.full_name, $new_full_name]
